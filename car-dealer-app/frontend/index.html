<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vroomm Vrommmm Car Dealership</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>üöó Vroomm Vrommmm Car Management üöó</h1>
        <p>Manage your dealership inventory</p>
        
        <!-- Database Action Buttons -->
        <div class="header-actions">
            <button id="seed-btn" onclick="seedDatabase()" class="action-btn seed-btn">
                üå± Seed DB
            </button>
            <button id="erase-btn" onclick="eraseDatabase()" class="action-btn erase-btn">
                üóëÔ∏è Erase DB
            </button>
        </div>
    </header>
    <main>
        <!-- Statistics Dashboard -->
        <div class="stats-section">
            <h2>üìä Dealership Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="total-cars">-</h3>
                    <p>Total Cars</p>
                </div>
                <div class="stat-card">
                    <h3 id="avg-price">-</h3>
                    <p>Average Price</p>
                </div>
                <div class="stat-card">
                    <h3 id="avg-mileage">-</h3>
                    <p>Average Mileage</p>
                </div>
                <div class="stat-card">
                    <h3 id="most-expensive">-</h3>
                    <p>Most Expensive</p>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>üîç Search Cars</h2>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search by brand, model, VIN, or year..." />
                <button onclick="searchCars()">Search</button>
                <button onclick="clearSearch()">Clear</button>
            </div>
            <div id="search-results"></div>
        </div>

        <!-- Add Car Section -->
        <div class="add-car-section">
            <h2>‚ûï Add New Car</h2>
            <form id="add-car-form">
                <div class="form-row">
                    <input type="text" id="vin" placeholder="VIN (e.g., 1HGBH41JXMN109186)" required>
                    <input type="number" id="year" placeholder="Year (e.g., 2024)" min="1900" max="2025" required>
                    <input type="text" id="brand" placeholder="Brand (e.g., Toyota)" required>
                </div>
                <div class="form-row">
                    <input type="text" id="model" placeholder="Model (e.g., Camry)" required>
                    <input type="number" id="mileage" placeholder="Mileage" min="0" required>
                    <input type="number" id="price" placeholder="Price ($)" min="0" step="0.01" required>
                </div>
                <button type="submit">Add Car</button>
            </form>
            <div id="add-message" class="message"></div>
        </div>

        <!-- Delete Section -->
        <div class="action-bar">
            <button id="delete-btn" onclick="deleteSelected()" disabled>üóëÔ∏è Delete Selected Cars</button>
            <span id="selected-count"></span>
            
            <!-- Sorting Controls -->
            <div class="sort-controls">
                <label>Sort by:</label>
                <select id="sort-by" onchange="loadCars(1)">
                    <option value="year">Year</option>
                    <option value="brand">Brand</option>
                    <option value="model">Model</option>
                    <option value="price">Price</option>
                    <option value="mileage">Mileage</option>
                    <option value="added_at">Date Added</option>
                </select>
                <select id="sort-order" onchange="loadCars(1)">
                    <option value="DESC">Descending ‚Üì</option>
                    <option value="ASC">Ascending ‚Üë</option>
                </select>
            </div>
        </div>

        <!-- Car List -->
        <div id="car-list"></div>
        
        <!-- Pagination -->
        <div class="pagination">
            <button onclick="prevPage()" id="prev-btn">Previous</button>
            <span id="page-num"></span>
            <button onclick="nextPage()" id="next-btn">Next</button>
        </div>
    </main>

    <!-- Car Detail Modal -->
    <div id="car-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üöó Car Details</h2>
            <div id="car-details"></div>
            <div class="modal-actions">
                <button onclick="editCar()" id="edit-car-btn">‚úèÔ∏è Edit Car</button>
                <button onclick="closeModal()" class="secondary">Close</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Vroomm Vrommmm. All rights reserved.</p>
    </footer>

    <script>
        let currentPage = 1;
        let total = 0;
        const perPage = 10;
        let selectedVins = new Set();
        let isSearchMode = false;
        let currentSearchQuery = '';
        let currentCarVin = null;

        // Load cars
        async function loadCars(page = 1) {
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            const res = await fetch(`/api/cars?page=${page}&sort_by=${sortBy}&sort_order=${sortOrder}`);
            const data = await res.json();
            total = data.total;
            currentPage = data.page;

            document.getElementById("page-num").textContent = `Page ${currentPage} of ${Math.ceil(total / perPage)}`;

            let html = `<table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>VIN</th>
                        <th>Year</th>
                        <th>Brand</th>
                        <th>Model</th>
                        <th>Mileage</th>
                        <th>Price</th>
                        <th>Date Added</th>
                    </tr>
                </thead>
                <tbody>`;
            
            for (let car of data.cars) {
                const isChecked = selectedVins.has(car.vin) ? 'checked' : '';
                const addedDate = car.added_at ? new Date(car.added_at).toLocaleString() : 'N/A';
                html += `<tr onclick="showCarDetails('${car.vin}')" style="cursor: pointer;">
                    <td onclick="event.stopPropagation()"><input type="checkbox" class="car-checkbox" value="${car.vin}" ${isChecked} onchange="updateSelection()"></td>
                    <td>${car.vin}</td>
                    <td>${car.year}</td>
                    <td>${car.brand}</td>
                    <td>${car.model}</td>
                    <td>${car.mileage.toLocaleString()} miles</td>
                    <td>$${car.price.toLocaleString()}</td>
                    <td>${addedDate}</td>
                </tr>`;
            }
            html += "</tbody></table>";
            document.getElementById("car-list").innerHTML = html;

            updateSelectionUI();

            // Disable buttons if necessary
            document.getElementById("prev-btn").disabled = currentPage === 1;
            document.getElementById("next-btn").disabled = currentPage * perPage >= total;
        }

        // Add car
        document.getElementById('add-car-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const carData = {
                vin: document.getElementById('vin').value,
                year: parseInt(document.getElementById('year').value),
                brand: document.getElementById('brand').value,
                model: document.getElementById('model').value,
                mileage: parseInt(document.getElementById('mileage').value),
                price: parseFloat(document.getElementById('price').value)
            };

            try {
                const res = await fetch('/api/cars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(carData)
                });

                const msg = document.getElementById('add-message');
                if (res.ok) {
                    msg.textContent = '‚úÖ Car added successfully!';
                    msg.className = 'message success';
                    document.getElementById('add-car-form').reset();
                    loadCars(currentPage);
                    setTimeout(() => msg.textContent = '', 3000);
                } else {
                    const error = await res.json();
                    msg.textContent = '‚ùå Error: ' + error.error;
                    msg.className = 'message error';
                }
            } catch (error) {
                const msg = document.getElementById('add-message');
                msg.textContent = '‚ùå Failed to add car';
                msg.className = 'message error';
            }
        });

        // Selection handling
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            const checkboxes = document.querySelectorAll('.car-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedVins.add(cb.value);
                } else {
                    selectedVins.delete(cb.value);
                }
            });
            updateSelectionUI();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.car-checkbox');
            selectedVins.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) selectedVins.add(cb.value);
            });
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedVins.size;
            const deleteBtn = document.getElementById('delete-btn');
            const countSpan = document.getElementById('selected-count');
            
            deleteBtn.disabled = count === 0;
            countSpan.textContent = count > 0 ? `(${count} selected)` : '';
        }

        // Delete selected cars
        async function deleteSelected() {
            if (selectedVins.size === 0) return;

            const carWord = selectedVins.size === 1 ? 'car' : 'cars';
            const confirmed = confirm(
                `‚ö†Ô∏è Are you sure you want to delete ${selectedVins.size} ${carWord}?\n\n` +
                `This action cannot be undone!`
            );

            if (!confirmed) return;

            try {
                const res = await fetch('/api/cars', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vins: Array.from(selectedVins) })
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`‚úÖ ${result.message}`);
                    selectedVins.clear();
                    loadCars(currentPage);
                } else {
                    const error = await res.json();
                    alert('‚ùå Error: ' + error.error);
                }
            } catch (error) {
                alert('‚ùå Failed to delete cars');
            }
        }

        function nextPage() {
            if (currentPage * perPage < total) {
                loadCars(currentPage + 1);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                loadCars(currentPage - 1);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                document.getElementById('total-cars').textContent = data.total_cars;
                document.getElementById('avg-price').textContent = '$' + data.average_price.toLocaleString();
                document.getElementById('avg-mileage').textContent = Math.round(data.average_mileage).toLocaleString() + ' mi';
                
                if (data.most_expensive.brand) {
                    document.getElementById('most-expensive').textContent = 
                        `${data.most_expensive.brand} ${data.most_expensive.model} ($${data.most_expensive.price.toLocaleString()})`;
                } else {
                    document.getElementById('most-expensive').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Search functionality
        async function searchCars(page = 1) {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            isSearchMode = true;
            currentSearchQuery = query;

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=${page}`);
                const data = await res.json();

                displaySearchResults(data);
                updateSearchPagination(data);
            } catch (error) {
                document.getElementById('search-results').innerHTML = '<p>‚ùå Search failed</p>';
            }
        }

        function displaySearchResults(data) {
            let html = `<h3>Search Results for "${data.query}" (${data.total} found)</h3>`;
            
            if (data.cars.length === 0) {
                html += '<p>No cars found matching your search.</p>';
            } else {
                html += `<table>
                    <thead>
                        <tr>
                            <th>VIN</th>
                            <th>Year</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Mileage</th>
                            <th>Price</th>
                            <th>Date Added</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                for (let car of data.cars) {
                    const addedDate = car.added_at ? new Date(car.added_at).toLocaleString() : 'N/A';
                    html += `<tr>
                        <td>${car.vin}</td>
                        <td>${car.year}</td>
                        <td>${car.brand}</td>
                        <td>${car.model}</td>
                        <td>${car.mileage.toLocaleString()} miles</td>
                        <td>$${car.price.toLocaleString()}</td>
                        <td>${addedDate}</td>
                    </tr>`;
                }
                html += "</tbody></table>";
                
                // Add search pagination
                html += `<div class="search-pagination">
                    <button onclick="searchCars(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${data.page} of ${Math.ceil(data.total / data.per_page)}</span>
                    <button onclick="searchCars(${data.page + 1})" ${data.page * data.per_page >= data.total ? 'disabled' : ''}>Next</button>
                </div>`;
            }
            
            document.getElementById('search-results').innerHTML = html;
        }

        function updateSearchPagination(data) {
            // Update the search pagination if needed
            currentPage = data.page;
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            isSearchMode = false;
            currentSearchQuery = '';
            loadCars(1);
        }

        // Allow Enter key in search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCars();
            }
        });

        // Modify loadCars to refresh stats
        const originalLoadCars = loadCars;
        loadCars = async function(page = 1) {
            await originalLoadCars(page);
            await loadStats(); // Refresh stats after loading cars
        };

        // Car details modal functionality

        async function showCarDetails(vin) {
            try {
                const res = await fetch(`/api/cars/${vin}`);
                const car = await res.json();
                
                if (res.ok) {
                    currentCarVin = vin;
                    const addedDate = car.added_at ? new Date(car.added_at).toLocaleString() : 'N/A';
                    
                    document.getElementById('car-details').innerHTML = `
                        <div class="car-detail-grid">
                            <div class="detail-item">
                                <strong>VIN:</strong> ${car.vin}
                            </div>
                            <div class="detail-item">
                                <strong>Year:</strong> ${car.year}
                            </div>
                            <div class="detail-item">
                                <strong>Brand:</strong> ${car.brand}
                            </div>
                            <div class="detail-item">
                                <strong>Model:</strong> ${car.model}
                            </div>
                            <div class="detail-item">
                                <strong>Mileage:</strong> ${car.mileage.toLocaleString()} miles
                            </div>
                            <div class="detail-item">
                                <strong>Price:</strong> $${car.price.toLocaleString()}
                            </div>
                            <div class="detail-item">
                                <strong>Added:</strong> ${addedDate}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('car-modal').style.display = 'block';
                } else {
                    alert('‚ùå Failed to load car details');
                }
            } catch (error) {
                alert('‚ùå Error loading car details');
            }
        }

        function closeModal() {
            document.getElementById('car-modal').style.display = 'none';
            currentCarVin = null;
        }

        function editCar() {
            if (!currentCarVin) return;
            
            // For now, just show an alert. In a real app, you'd open an edit form
            alert(`üöß Edit functionality for ${currentCarVin} would open here.\n\nThis could include:\n- Edit form with current values\n- Update API call\n- Refresh the car list`);
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Database management functions
        async function seedDatabase() {
            const confirmed = confirm(
                "üå± Seed Database\n\n" +
                "This will add 50 sample cars to your database WITHOUT clearing existing data.\n\n" +
                "Continue?"
            );
            
            if (!confirmed) return;
            
            const seedBtn = document.getElementById('seed-btn');
            seedBtn.disabled = true;
            seedBtn.textContent = 'üîÑ Seeding...';
            
            try {
                const res = await fetch('/api/seed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ ${result.message}\n\nNew cars have been added to your database!`);
                    // Refresh the car list and statistics
                    await loadCars();
                    await loadStats();
                } else {
                    alert(`‚ùå Seeding failed: ${result.error}`);
                }
            } catch (error) {
                alert('‚ùå Error connecting to backend for seeding');
                console.error('Seed error:', error);
            } finally {
                seedBtn.disabled = false;
                seedBtn.textContent = 'üå± Seed DB';
            }
        }

        async function eraseDatabase() {
            const confirmed = confirm(
                "‚ö†Ô∏è DANGER: Erase Database\n\n" +
                "This will DELETE ALL CARS from your database!\n\n" +
                "This action CANNOT be undone!\n\n" +
                "Are you absolutely sure you want to continue?"
            );
            
            if (!confirmed) return;
            
            // Double confirmation for destructive action
            const doubleConfirmed = confirm(
                "üö® FINAL WARNING üö®\n\n" +
                "You are about to PERMANENTLY DELETE all car data!\n\n" +
                "Click OK only if you are 100% sure!"
            );
            
            if (!doubleConfirmed) return;
            
            const eraseBtn = document.getElementById('erase-btn');
            eraseBtn.disabled = true;
            eraseBtn.textContent = 'üîÑ Erasing...';
            
            try {
                const res = await fetch('/api/erase', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ ${result.message}\n\nDatabase has been completely cleared.`);
                    // Refresh the car list and statistics
                    await loadCars();
                    await loadStats();
                } else {
                    alert(`‚ùå Erase failed: ${result.error}`);
                }
            } catch (error) {
                alert('‚ùå Error connecting to backend for erasing');
                console.error('Erase error:', error);
            } finally {
                eraseBtn.disabled = false;
                eraseBtn.textContent = 'üóëÔ∏è Erase DB';
            }
        }

        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            alert('‚ùå An unexpected error occurred. Please refresh the page and try again.');
        });

        // Load initial data
        loadCars();
        loadStats();
    </script>
</body>

</html>